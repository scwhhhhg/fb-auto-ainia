const puppeteer=require("puppeteer"),fs=require("fs").promises,path=require("path"),axios=require("axios"),config=require("../config/configkomenvideo.json"),fetch=require("node-fetch"),VALIDATION_SERVER_URL="https://license-server-botnews.vercel.app/api/validate",PRODUCT_NAME="autokomenfb";async function checkLicense(){console.log("Memulai validasi lisensi...");const e=process.env.BOT_LICENSE_EMAIL;if(!e)throw new Error("KESALAHAN: GitHub Secret 'BOT_LICENSE_EMAIL' tidak ditemukan.");const a=`${VALIDATION_SERVER_URL}?email=${encodeURIComponent(e)}&product=${PRODUCT_NAME}`;try{const e=await fetch(a),t=await e.json();if(e.ok&&"valid"===t.status)return console.log("‚úÖ Lisensi valid."),!0;throw new Error(`Lisensi tidak valid - Pesan dari server: ${t.message||"Tidak ada pesan"}`)}catch(e){throw new Error(`Gagal menghubungi server lisensi: ${e.message}`)}}const LOG_PATH=path.join(__dirname,"../ceklink.txt"),COMMENTS_PATH=path.join(__dirname,"../comments.txt"),CTA_LINK_PATH=path.join(__dirname,"../cta_link.txt"),GEMINI_KEYS_PATH=path.join(__dirname,"../gemini_keys.txt"),ARTIFACTS_DIR=path.join(__dirname,"../artifacts"),delay=e=>new Promise(a=>setTimeout(a,e)),getRandomInterval=()=>1e3*(Math.floor(Math.random()*(config.maxIntervalSeconds-config.minIntervalSeconds+1))+config.minIntervalSeconds);async function loadCookiesFromEnv(){const e=process.env.FACEBOOK_COOKIES;if(!e)throw new Error("Secret FACEBOOK_COOKIES belum diatur di GitHub!");return JSON.parse(e).map(e=>({name:e.name,value:e.value,domain:e.domain,path:e.path}))}async function loadLog(){try{const e=await fs.readFile(LOG_PATH,"utf8");return new Set(e.split("\n").filter(e=>""!==e.trim()))}catch(e){if("ENOENT"===e.code)return new Set;throw e}}async function loadComments(){try{return(await fs.readFile(COMMENTS_PATH,"utf8")).split("---").map(e=>e.trim()).filter(e=>e)}catch(e){if("ENOENT"===e.code)return[];throw e}}async function loadCtaLink(){try{return(await fs.readFile(CTA_LINK_PATH,"utf8")).trim()}catch(e){return console.log("Peringatan: file cta_link.txt tidak ditemukan."),""}}async function loadGeminiApiKeys(){try{const e=(await fs.readFile(GEMINI_KEYS_PATH,"utf8")).split("\n").map(e=>e.trim()).filter(e=>e);if(0===e.length)throw new Error("File gemini_keys.txt kosong!");return e}catch(e){if("ENOENT"===e.code)throw new Error("File gemini_keys.txt tidak ditemukan!");throw e}}async function appendToLog(e){await fs.appendFile(LOG_PATH,`${e}\n`)}async function getAiComment(e,a,t,o){if(console.log("   -> Menghubungi Gemini AI untuk membuat komentar..."),!e||""===e.trim())return console.log("   -> ‚ö†Ô∏è Caption kosong, AI tidak bisa membuat komentar."),{comment:null,workingIndex:o};const n=config.ai_settings.gemini_prompt.replace("{CAPTION_POSTINGAN}",e).replace("{LINK_CTA}",a);for(let e=o;e<t.length;e++){const a=t[e];console.log(`   -> Mencoba menggunakan API Key #${e+1}...`);try{const t=(await axios.post(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${a}`,{contents:[{parts:[{text:n}]}]},{headers:{"Content-Type":"application/json"}})).data.candidates[0].content.parts[0].text;return console.log("   -> ‚úÖ Komentar dari AI berhasil didapatkan."),{comment:t.trim(),workingIndex:e}}catch(a){if(console.error(`   -> ‚ùå Gagal dengan API Key #${e+1}:`,a.response?a.response.data.error.message:a.message),e===t.length-1)return console.error("   -> Semua API Key gagal."),{comment:null,workingIndex:e}}}return{comment:null,workingIndex:o}}async function main(){let e;try{await checkLicense(),console.log("üöÄ Memulai bot Auto Komen Video..."),await fs.mkdir(ARTIFACTS_DIR,{recursive:!0});const a=await loadComments();let t="",o=[];if(config.ai_settings.enabled&&(t=await loadCtaLink(),o=await loadGeminiApiKeys()),!config.ai_settings.enabled&&0===a.length)throw new Error("Mode AI nonaktif dan file comments.txt kosong!");e=await puppeteer.launch({headless:config.headless,args:["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage"]});const n=await e.newPage();await n.setViewport({width:1280,height:1024}),console.log("üîë Memuat cookies...");const i=await loadCookiesFromEnv();await n.setCookie(...i),console.log(`‚úÖ ${i.length} cookies berhasil dimuat.`),console.log(`Navigasi ke: ${config.targetURL}`),await n.goto(config.targetURL,{waitUntil:"networkidle2"}),console.log("Menunggu halaman memuat konten awal..."),await delay(1e4),console.log("‚úÖ Halaman dianggap sudah siap.");const r=await loadLog();let s=r.size%(a.length||1),l=0;console.log(`üéØ Target: ${config.postsToComment} komentar.`);let c=0,d=0;for(;l<config.postsToComment&&c<5;){const e=await n.evaluate(()=>{const e=[],a=document.querySelectorAll('div[data-virtualized="false"]');for(const t of a){const a=t.querySelector('a[href*="/watch/?v="]'),o=t.querySelector('span[dir="auto"]');a&&e.push({url:a.href.split("&")[0],caption:o&&o.textContent||""})}return e});if(console.log(`Menemukan ${e.length} video potensial di layar.`),0===e.length){console.log("Tidak ada video ditemukan. Scroll ke bawah..."),await n.evaluate(()=>window.scrollBy(0,800)),await delay(5e3),c++;continue}let i=!1;for(const g of e)try{if(r.has(g.url))continue;let e;if(config.ai_settings.enabled){const a=await getAiComment(g.caption,t,o,d);if(e=a.comment,d=a.workingIndex,!e){await appendToLog(g.url);continue}}else e=a[s%a.length];console.log(`\nNavigasi ke halaman video: ${g.url}`),await n.goto(g.url,{waitUntil:"networkidle2"}),await delay(5e3);const m=await n.waitForSelector('div[aria-label="Beri komentar"]',{timeout:1e4});await m.click({delay:100}),console.log('   -> ‚úÖ Tombol "Beri komentar" diklik.'),await delay(5e3),console.log(`   -> üí¨ Mengetik komentar:\n${e}`);const u=e.split("\n");for(const e of u)await n.keyboard.type(e,{delay:100}),await n.keyboard.down("Shift"),await n.keyboard.press("Enter"),await n.keyboard.up("Shift");await n.keyboard.press("Enter"),console.log("   -> ‚úÖ Komentar dikirim."),await appendToLog(g.url),r.add(g.url),l++,config.ai_settings.enabled||s++,i=!0,c=0,await delay(getRandomInterval()),console.log(`Kembali ke ${config.targetURL}...`),await n.goto(config.targetURL,{waitUntil:"networkidle2"}),await delay(5e3);break}catch(e){console.error(`   -> ‚ùå Gagal berinteraksi: ${e.message}`),await n.goto(config.targetURL,{waitUntil:"networkidle2"}),await delay(5e3);break}i||(console.log("Semua video terlihat sudah diproses. Scroll ke bawah..."),await n.evaluate(()=>window.scrollBy(0,window.innerHeight)),await delay(5e3),c++)}c>=5&&console.log("‚ùå Tidak ada video baru ditemukan setelah 5 kali scroll. Bot berhenti.")}catch(e){console.error("Terjadi error fatal:",e.message),process.exit(1)}finally{e&&await e.close(),console.log("üèÅ Bot selesai.")}}main();
