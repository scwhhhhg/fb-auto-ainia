const puppeteer=require("puppeteer"),fs=require("fs").promises,path=require("path"),config=require("../config/configpostgroup.json"),fetch=require("node-fetch"),VALIDATION_SERVER_URL="https://license-server-botnews.vercel.app/api/validate",PRODUCT_NAME="autokomenfb";async function checkLicense(){console.log("Memulai validasi lisensi...");const e=process.env.BOT_LICENSE_EMAIL;if(!e)throw new Error("KESALAHAN: GitHub Secret 'BOT_LICENSE_EMAIL' tidak ditemukan.");const t=`${VALIDATION_SERVER_URL}?email=${encodeURIComponent(e)}&product=${PRODUCT_NAME}`;try{const e=await fetch(t),a=await e.json();if(e.ok&&"valid"===a.status)return console.log("‚úÖ Lisensi valid."),!0;throw new Error(`Lisensi tidak valid - Pesan dari server: ${a.message||"Tidak ada pesan"}`)}catch(e){throw new Error(`Gagal menghubungi server lisensi: ${e.message}`)}}const TARGET_GROUPS_PATH=path.join(__dirname,"../target_groups.txt"),POST_CONTENT_PATH=path.join(__dirname,"../post_content.txt"),LAST_CONTENT_INDEX_PATH=path.join(__dirname,"../last_content_index.txt"),ARTIFACTS_DIR=path.join(__dirname,"artifacts"),delay=e=>new Promise(t=>setTimeout(t,e)),getRandomInterval=()=>1e3*(Math.floor(Math.random()*(config.maxIntervalSeconds-config.minIntervalSeconds+1))+config.minIntervalSeconds);async function loadCookiesFromEnv(){const e=process.env.FACEBOOK_COOKIES;if(!e)throw new Error("Secret FACEBOOK_COOKIES belum diatur di GitHub!");return JSON.parse(e).map(e=>({name:e.name,value:e.value,domain:e.domain,path:e.path}))}async function loadTargetGroups(){try{return(await fs.readFile(TARGET_GROUPS_PATH,"utf8")).split("\n").filter(e=>""!==e.trim())}catch(e){if("ENOENT"===e.code)throw new Error("File target_groups.txt tidak ditemukan!");throw e}}async function loadPostContent(){try{return(await fs.readFile(POST_CONTENT_PATH,"utf8")).split("---").map(e=>e.trim()).filter(e=>e)}catch(e){if("ENOENT"===e.code)throw new Error("File post_content.txt tidak ditemukan!");throw e}}async function loadLastContentIndex(){try{const e=await fs.readFile(LAST_CONTENT_INDEX_PATH,"utf8");return parseInt(e.trim(),10)}catch(e){return 0}}async function saveLastContentIndex(e){await fs.writeFile(LAST_CONTENT_INDEX_PATH,String(e),"utf8")}async function main(){let e;try{await checkLicense(),console.log("üöÄ Memulai bot Auto Posting Grup..."),await fs.mkdir(ARTIFACTS_DIR,{recursive:!0});const t=await loadTargetGroups(),a=await loadPostContent();let o=await loadLastContentIndex();if(0===t.length)return void console.log("Tidak ada grup target di file target_groups.txt. Bot berhenti.");if(0===a.length)return void console.log("File post_content.txt kosong. Bot berhenti.");e=await puppeteer.launch({headless:config.headless,args:["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage"]});const n=await e.newPage();await n.setViewport({width:1280,height:800}),console.log("üîë Memuat cookies...");const i=await loadCookiesFromEnv();await n.setCookie(...i),console.log(`‚úÖ ${i.length} cookies berhasil dimuat.`);for(const e of t)try{const t=a[o%a.length];console.log(`\nNavigasi ke grup: ${e}`),console.log(`Konten yang akan diposting (konten ke-${o%a.length+1}):`),await n.goto(e,{waitUntil:"networkidle2"}),await delay(7e3),console.log("Mencari area untuk membuat postingan...");const i='xpath/ //div[@role="button" and (contains(., "Tulis sesuatu") or contains(., "Write something"))]';await n.waitForSelector(i,{timeout:15e3});const r=await n.$(i);await r.click(),console.log("‚úÖ Area postingan diaktifkan."),await delay(3e3),console.log("Mengetik konten postingan...");const s='div[aria-placeholder*="post"], div[aria-placeholder*="Tulis"]';await n.waitForSelector(s,{timeout:1e4}),await n.type(s,t,{delay:50}),console.log(`üïí Menunggu ${config.linkPreviewIntervalSeconds} detik untuk pratinjau link...`),await delay(1e3*config.linkPreviewIntervalSeconds);const l='div[aria-label="Post"][role="button"], div[aria-label="Posting"][role="button"]';console.log('Mencari tombol "Post"...'),await n.waitForSelector(l,{timeout:1e4,visible:!0});const c=await n.$(l);await c.click(),console.log(`‚úÖ Berhasil posting ke: ${e}`),o++;const d=getRandomInterval();console.log(`üïí Jeda selama ${d/1e3} detik sebelum ke grup berikutnya...`),await delay(d)}catch(a){console.error(`‚ùå Gagal posting ke ${e}: ${a.message}`),await n.screenshot({path:path.join(ARTIFACTS_DIR,`error_grup_${t.indexOf(e)}.png`)})}await saveLastContentIndex(o)}catch(e){console.error("Terjadi error fatal:",e.message),process.exit(1)}finally{e&&await e.close(),console.log("üèÅ Bot selesai.")}}main();
